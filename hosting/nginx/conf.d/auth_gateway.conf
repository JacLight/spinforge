# SpinForge API Gateway Authentication Configuration

# Shared memory zones for caching
lua_shared_dict auth_cache 10m;
lua_shared_dict rate_limit 10m;

# Initialize auth module
init_by_lua_block {
    auth_gateway = require "auth_gateway"
}

# OAuth callback endpoint (handles all domains)
server {
    listen 80;
    listen 443 ssl;
    server_name ~^.*$;
    
    location = /_oauth/callback {
        access_by_lua_block {
            auth_gateway.authenticate()
        }
    }
}

# Add authentication to all virtual hosts
# This is included in the main server blocks via include directive
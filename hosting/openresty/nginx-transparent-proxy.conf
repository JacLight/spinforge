# Transparent proxy configuration for AI APIs
# This configuration removes proxy identification headers

location @transparent_proxy {
    internal;
    
    # DNS resolver for dynamic proxy targets
    resolver 127.0.0.11 8.8.8.8 8.8.4.4 valid=30s;
    resolver_timeout 10s;
    
    # Proxy settings
    proxy_pass $proxy_target;
    
    # Extract hostname from proxy target URL for Host header
    set $proxy_host '';
    access_by_lua_block {
        local target = ngx.var.proxy_target
        if target then
            local host = target:match("https?://([^/]+)")
            if host then
                ngx.var.proxy_host = host
                ngx.log(ngx.INFO, "Transparent Proxy: Using host: ", host)
            end
        end
    }
    
    # Set only the Host header - no proxy identification headers
    proxy_set_header Host $proxy_host;
    
    # Remove any existing proxy headers
    proxy_set_header X-Real-IP "";
    proxy_set_header X-Forwarded-For "";
    proxy_set_header X-Forwarded-Proto "";
    proxy_set_header X-Forwarded-Host "";
    proxy_set_header Via "";
    proxy_set_header X-Forwarded-Server "";
    proxy_set_header X-Forwarded-Port "";
    
    # SSL/SNI settings for HTTPS backends
    proxy_ssl_server_name on;
    proxy_ssl_name $proxy_host;
    proxy_ssl_verify off;
    
    # Pass through all other headers unchanged
    proxy_pass_request_headers on;
    
    # Handle backend responses
    proxy_intercept_errors off;
    
    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    # Disable buffering for streaming
    proxy_buffering off;
    proxy_cache off;
    proxy_request_buffering off;
    proxy_http_version 1.1;
    
    # Support for keep-alive
    proxy_set_header Connection "";
    
    # Hide proxy response headers
    proxy_hide_header X-Powered-By;
    proxy_hide_header Server;
}